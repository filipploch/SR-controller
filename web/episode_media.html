<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Odcinka</title>
    <link rel="stylesheet" href="/static/css/shared.css">
    <style>
        .content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .episode-info {
            font-size: 11px;
            color: #aaa;
        }

        .episode-info strong {
            color: #fff;
        }

        .media-type-badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 8px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .media-type-reportages { background: #66bb6a; }
        .media-type-videos { background: #ffa726; }
        .media-type-images { background: #42a5f5; }
        .media-type-audio { background: #ab47bc; }

        .duration {
            color: #888;
            font-size: 9px;
        }

        .file-browser {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
        }

        .file-item {
            padding: 4px 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            margin-bottom: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .file-item.selected {
            background: rgba(102, 126, 234, 0.3);
            border: 1px solid #667eea;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Media Odcinka</h1>
            <div class="status">
                <div class="status-item">
                    <div class="status-dot connected"></div>
                    <span>System</span>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="toolbar">
                <div class="episode-info" id="episodeInfo">
                    <span>Wybierz odcinek...</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <select class="form-control" id="episodeSelect" onchange="loadEpisodeMedia()" style="width: 250px;">
                        <option value="">Wybierz odcinek...</option>
                    </select>
                    <button class="btn btn-primary btn-small" onclick="openAddModal()" id="addBtn" disabled>+ Dodaj Media</button>
                </div>
            </div>

            <div class="scrollable">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Typ</th>
                            <th>Tytu≈Ç</th>
                            <th style="width: 100px;">Autor</th>
                            <th style="width: 80px;">Duration</th>
                            <th style="width: 60px;">Kolejno≈õƒá</th>
                            <th style="width: 120px;">Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="mediaTableBody">
                        <tr>
                            <td colspan="6" class="loading">Wybierz odcinek...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal dodawania/edycji -->
    <div class="modal" id="mediaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Dodaj Media</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="mediaForm">
                <input type="hidden" id="mediaId">
                
                <!-- Upload pliku -->
                <div class="form-group">
                    <label>Upload Pliku</label>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="fileInput" style="display: none;" accept="video/*,audio/*,image/*">
                        <div id="uploadText">üìÅ Kliknij lub przeciƒÖgnij plik</div>
                    </div>
                </div>

                <!-- LUB wybierz istniejƒÖcy -->
                <div class="form-group">
                    <label>Lub Wybierz IstniejƒÖcy Plik</label>
                    <button type="button" class="btn btn-small" onclick="loadAvailableFiles()">üìÇ PrzeglƒÖdaj pliki</button>
                    <div class="file-browser" id="fileBrowser" style="display: none;">
                        <div class="loading">≈Åadowanie...</div>
                    </div>
                    <input type="hidden" id="selectedFilePath">
                </div>

                <div class="form-group">
                    <label for="mediaTitle">Tytu≈Ç *</label>
                    <input type="text" class="form-control" id="mediaTitle" required>
                </div>

                <div class="form-group">
                    <label for="mediaDescription">Opis</label>
                    <textarea class="form-control" id="mediaDescription"></textarea>
                </div>

                <div class="form-group">
                    <label for="mediaSource">≈πr√≥d≈Ço OBS</label>
                    <select class="form-control" id="mediaSource">
                        <option value="">Brak</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mediaAuthor">Autor</label>
                    <select class="form-control" id="mediaAuthor">
                        <option value="">Brak</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mediaDuration">Duration (sekundy)</label>
                    <input type="number" class="form-control" id="mediaDuration" readonly>
                </div>

                <div class="form-group">
                    <label for="mediaOrder">Kolejno≈õƒá</label>
                    <input type="number" class="form-control" id="mediaOrder" value="0">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal()">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentEpisodeId = null;
        let episodes = [];
        let media = [];
        let sources = [];
        let staff = [];
        let availableFiles = [];
        let selectedFile = null;
        let uploadedFile = null;

        // ≈Åadowanie odcink√≥w
        async function loadEpisodes() {
            try {
                const response = await fetch('/api/episodes');
                episodes = await response.json();
                
                const select = document.getElementById('episodeSelect');
                select.innerHTML = '<option value="">Wybierz odcinek...</option>' +
                    episodes.map(ep => `<option value="${ep.id}">S${ep.season?.number || '?'}E${ep.season_episode} - ${ep.title}</option>`).join('');
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania odcink√≥w:', error);
            }
        }

        // ≈Åadowanie ≈∫r√≥de≈Ç i staff
        async function loadSourcesAndStaff() {
            try {
                // Pobierz ≈∫r√≥d≈Ça ze scen REPORTAZE i MEDIA
                const scenesResponse = await fetch('/api/scenes'); // Trzeba bƒôdzie dodaƒá ten endpoint
                // Tymczasowo zak≈Çadamy ≈ºe sƒÖ dostƒôpne
                
                const staffResponse = await fetch('/api/staff');
                staff = await staffResponse.json();
                
                updateSourceSelect();
                updateAuthorSelect();
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania danych:', error);
            }
        }

        function updateSourceSelect() {
            const select = document.getElementById('mediaSource');
            select.innerHTML = '<option value="">Brak</option>'; // + sources mapping
        }

        function updateAuthorSelect() {
            const select = document.getElementById('mediaAuthor');
            select.innerHTML = '<option value="">Brak</option>' +
                staff.map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('');
        }

        // ≈Åadowanie medi√≥w odcinka
        async function loadEpisodeMedia() {
            const episodeId = document.getElementById('episodeSelect').value;
            
            if (!episodeId) {
                document.getElementById('mediaTableBody').innerHTML = '<tr><td colspan="6" class="loading">Wybierz odcinek...</td></tr>';
                document.getElementById('addBtn').disabled = true;
                return;
            }

            currentEpisodeId = episodeId;
            document.getElementById('addBtn').disabled = false;

            const episode = episodes.find(e => e.id == episodeId);
            document.getElementById('episodeInfo').innerHTML = `<strong>Odcinek:</strong> S${episode.season?.number}E${episode.season_episode} - ${episode.title}`;

            try {
                const response = await fetch(`/api/episodes/${episodeId}/media`);
                media = await response.json();
                renderMedia();
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania medi√≥w:', error);
            }
        }

        function getMediaTypeName(filePath) {
            if (!filePath) return 'unknown';
            if (filePath.includes('reportages/')) return 'reportages';
            if (filePath.includes('videos/')) return 'videos';
            if (filePath.includes('images/')) return 'images';
            if (filePath.includes('audio/')) return 'audio';
            return 'unknown';
        }

        function renderMedia() {
            const tbody = document.getElementById('mediaTableBody');
            
            if (media.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üé¨</div><div>Brak medi√≥w</div></div></td></tr>';
                return;
            }

            tbody.innerHTML = media.map(m => {
                const mediaType = getMediaTypeName(m.file_path);
                const duration = m.duration ? `${Math.floor(m.duration / 60)}:${String(m.duration % 60).padStart(2, '0')}` : '-';
                const author = m.staff ? `${m.staff.first_name} ${m.staff.last_name}` : '-';

                return `
                    <tr>
                        <td><span class="media-type-badge media-type-${mediaType}">${mediaType}</span></td>
                        <td><strong>${m.title}</strong></td>
                        <td>${author}</td>
                        <td class="duration">${duration}</td>
                        <td>${m.order}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-primary btn-small" onclick="editMedia(${m.id})">Edytuj</button>
                                <button class="btn btn-danger btn-small" onclick="deleteMedia(${m.id})">Usu≈Ñ</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Upload pliku
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            await uploadFile(file);
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) await uploadFile(file);
        });

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('media_type', 'videos'); // Domy≈õlnie videos, mo≈ºna dodaƒá wyb√≥r

            document.getElementById('uploadText').textContent = 'Uploading...';

            try {
                const response = await fetch(`/api/episodes/${currentEpisodeId}/media/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    uploadedFile = data;
                    document.getElementById('uploadText').textContent = `‚úì ${data.filename} (${data.duration}s)`;
                    document.getElementById('selectedFilePath').value = data.file_path;
                    document.getElementById('mediaDuration').value = data.duration;
                    document.getElementById('mediaTitle').value = data.filename.replace(/\.[^/.]+$/, ""); // Bez rozszerzenia
                } else {
                    alert('B≈ÇƒÖd uploadu');
                    document.getElementById('uploadText').textContent = 'üìÅ Kliknij lub przeciƒÖgnij plik';
                }
            } catch (error) {
                console.error('B≈ÇƒÖd uploadu:', error);
                alert('B≈ÇƒÖd po≈ÇƒÖczenia');
                document.getElementById('uploadText').textContent = 'üìÅ Kliknij lub przeciƒÖgnij plik';
            }
        }

        // PrzeglƒÖdanie istniejƒÖcych plik√≥w
        async function loadAvailableFiles() {
            const browser = document.getElementById('fileBrowser');
            browser.style.display = 'block';
            browser.innerHTML = '<div class="loading">≈Åadowanie...</div>';

            try {
                const response = await fetch(`/api/episodes/${currentEpisodeId}/media/files`);
                availableFiles = await response.json();

                if (availableFiles.length === 0) {
                    browser.innerHTML = '<div style="text-align: center; color: #888; font-size: 10px;">Brak plik√≥w</div>';
                    return;
                }

                browser.innerHTML = availableFiles.map((file, idx) => `
                    <div class="file-item" onclick="selectFile(${idx})">
                        <span>${file.name}</span>
                        <span class="duration">${file.duration}s</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania plik√≥w:', error);
                browser.innerHTML = '<div style="text-align: center; color: #f00; font-size: 10px;">B≈ÇƒÖd</div>';
            }
        }

        function selectFile(index) {
            // Odznacz poprzedni
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
            
            // Zaznacz nowy
            document.querySelectorAll('.file-item')[index].classList.add('selected');
            
            selectedFile = availableFiles[index];
            document.getElementById('selectedFilePath').value = selectedFile.path;
            document.getElementById('mediaDuration').value = selectedFile.duration;
            document.getElementById('mediaTitle').value = selectedFile.name.replace(/\.[^/.]+$/, "");
        }

        // Modal
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Dodaj Media';
            document.getElementById('mediaForm').reset();
            document.getElementById('mediaId').value = '';
            document.getElementById('uploadText').textContent = 'üìÅ Kliknij lub przeciƒÖgnij plik';
            document.getElementById('fileBrowser').style.display = 'none';
            uploadedFile = null;
            selectedFile = null;
            document.getElementById('mediaModal').classList.add('active');
        }

        function editMedia(id) {
            const m = media.find(med => med.id === id);
            if (!m) return;

            document.getElementById('modalTitle').textContent = 'Edycja Media';
            document.getElementById('mediaId').value = m.id;
            document.getElementById('mediaTitle').value = m.title;
            document.getElementById('mediaDescription').value = m.description || '';
            document.getElementById('mediaSource').value = m.source_id || '';
            document.getElementById('mediaAuthor').value = m.staff_id || '';
            document.getElementById('mediaDuration').value = m.duration || '';
            document.getElementById('mediaOrder').value = m.order || 0;
            document.getElementById('selectedFilePath').value = m.file_path || '';
            document.getElementById('mediaModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('mediaModal').classList.remove('active');
        }

        // Zapisz media
        document.getElementById('mediaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('mediaId').value;
            const filePath = document.getElementById('selectedFilePath').value;

            if (!filePath && !id) {
                alert('Wybierz lub upload plik');
                return;
            }

            const data = {
                title: document.getElementById('mediaTitle').value,
                description: document.getElementById('mediaDescription').value,
                source_id: parseInt(document.getElementById('mediaSource').value) || null,
                staff_id: parseInt(document.getElementById('mediaAuthor').value) || null,
                file_path: filePath || null,
                duration: parseInt(document.getElementById('mediaDuration').value) || 0,
                order: parseInt(document.getElementById('mediaOrder').value) || 0
            };

            try {
                const url = id ? `/api/episodes/${currentEpisodeId}/media/${id}` : `/api/episodes/${currentEpisodeId}/media`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    loadEpisodeMedia();
                } else {
                    const error = await response.text();
                    alert('B≈ÇƒÖd: ' + error);
                }
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('B≈ÇƒÖd po≈ÇƒÖczenia');
            }
        });

        // Usu≈Ñ media
        async function deleteMedia(id) {
            if (!confirm('Czy na pewno usunƒÖƒá to media?')) return;

            try {
                const response = await fetch(`/api/episodes/${currentEpisodeId}/media/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadEpisodeMedia();
                } else {
                    alert('B≈ÇƒÖd usuwania');
                }
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
            }
        }

        // Inicjalizacja
        loadEpisodes();
        loadSourcesAndStaff();
    </script>
</body>
</html>